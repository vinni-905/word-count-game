```html
<!DOCTYPE html>
<html lang="en"> <!-- Theme class added by JS -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WordLinks - Home</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root { /* Light Theme (Default) */
            --bg-gradient-start: #f8f9fa;
            --bg-gradient-end: #ffffff;
            --container-bg: #ffffff;
            --text-primary: #343a40;
            --text-secondary: #6c757d;
            --accent-primary: #007bff;
            --button-easy-bg: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
            --button-easy-hover: linear-gradient(135deg, #1e7e34 0%, #155724 100%);
            --button-medium-bg: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            --button-medium-hover: linear-gradient(135deg, #e0a800 0%, #c69500 100%);
            --button-hard-bg: linear-gradient(135deg, #dc3545 0%, #b02a37 100%);
            --button-hard-hover: linear-gradient(135deg, #b02a37 0%, #8c222c 100%);
            --button-stats-bg: linear-gradient(135deg, #17a2b8 0%, #117a8b 100%);
            --button-stats-hover: linear-gradient(135deg, #117a8b 0%, #0f6674 100%);
            --button-daily-bg: linear-gradient(135deg, #6f42c1 0%, #4a2490 100%); 
            --button-daily-hover: linear-gradient(135deg, #4a2490 0%, #321861 100%);
            --button-disabled-bg: #ced4da;
            --button-disabled-text: #6c757d;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 8px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 20px rgba(0,0,0,0.1);
            --transition-speed: 0.25s;
            --modal-overlay-bg: rgba(0, 0, 0, 0.6);
            --stat-item-bg: #f8f9fa;
            --theme-toggle-btn-color: var(--text-secondary);
            --theme-toggle-btn-hover-color: var(--text-primary);
            --error-bg: #f8d7da;
            --error-text: #842029;
            --error-border: #f5c2c7;
            --spinner-light: #f3f3f3;
            --spinner-dark: var(--accent-primary);
            --input-bg: #fff;
            --input-border: #ced4da;
            --input-focus-border: var(--accent-primary);
            --label-color: var(--text-secondary);
            --star-color: #FFD700;
            --badge-perfect-bg: var(--button-success-bg);
            --leaderboard-filter-bg: var(--input-bg);
            --leaderboard-filter-border: var(--input-border);
            --leaderboard-table-border: var(--input-border);
        }

        html.dark-theme { /* Dark Theme Overrides */
            --bg-gradient-start: #212529;
            --bg-gradient-end: #343a40;
            --container-bg: #495057;
            --text-primary: #f8f9fa;
            --text-secondary: #adb5bd;
            --accent-primary: #0d6efd;
            --button-easy-bg: linear-gradient(135deg, #1a6130 0%, #144b24 100%);
            --button-easy-hover: linear-gradient(135deg, #144b24 0%, #0e3619 100%);
            --button-medium-bg: linear-gradient(135deg, #b38600 0%, #997100 100%);
            --button-medium-hover: linear-gradient(135deg, #997100 0%, #7d5c00 100%);
            --button-hard-bg: linear-gradient(135deg, #9a2430 0%, #7a1d26 100%);
            --button-hard-hover: linear-gradient(135deg, #7a1d26 0%, #5c161c 100%);
            --button-stats-bg: linear-gradient(135deg, #0f7485 0%, #0b5a68 100%);
            --button-stats-hover: linear-gradient(135deg, #0b5a68 0%, #084c58 100%);
            --button-daily-bg: linear-gradient(135deg, #59359a 0%, #3c1e72 100%);
            --button-daily-hover: linear-gradient(135deg, #3c1e72 0%, #2c1553 100%);
            --button-disabled-bg: #5a6268;
            --button-disabled-text: #adb5bd;
            --modal-overlay-bg: rgba(0, 0, 0, 0.8);
            --stat-item-bg: #343a40;
            --theme-toggle-btn-color: var(--text-secondary);
            --theme-toggle-btn-hover-color: var(--text-primary);
            --error-bg: #591C21;
            --error-text: #f5c2c7;
            --error-border: #c87079;
            --spinner-light: #495057;
            --spinner-dark: var(--accent-primary);
            --input-bg: #343a40;
            --input-border: #6c757d;
            --input-focus-border: var(--accent-primary);
            --label-color: var(--text-secondary);
            --star-color: #FFC107;
            --badge-perfect-bg: var(--button-success-bg);
            --leaderboard-filter-bg: var(--input-bg);
            --leaderboard-filter-border: var(--input-border);
            --leaderboard-table-border: var(--input-border);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Poppins', sans-serif; line-height: 1.6;
            background: linear-gradient(to bottom, var(--bg-gradient-start), var(--bg-gradient-end));
            color: var(--text-primary); padding: 20px; min-height: 100vh;
            display: flex; align-items: center; justify-content: center; text-align: center;
            opacity: 0; animation: fadeInPage 0.5s ease-out forwards;
            transition: background var(--transition-speed) ease, color var(--transition-speed) ease;
        }
        @keyframes fadeInPage { to { opacity: 1; } }
        body.fade-out { opacity: 1; animation: fadeOutPage 0.3s ease-in forwards; }
        @keyframes fadeOutPage { to { opacity: 0; } }
        .container {
            width: 100%; max-width: 550px; margin: 20px auto;
            background: var(--container-bg); padding: 40px; border-radius: 16px;
            box-shadow: var(--shadow-lg); position: relative;
            transition: background-color var(--transition-speed) ease;
        }
        #theme-toggle-btn {
            position: absolute; top: 20px; right: 20px; background: none;
            border: none; font-size: 1.3em; cursor: pointer;
            color: var(--theme-toggle-btn-color); padding: 5px;
            transition: color var(--transition-speed) ease, transform var(--transition-speed) ease;
        }
        #theme-toggle-btn:hover { color: var(--theme-toggle-btn-hover-color); transform: scale(1.1); }
        h1 {
            color: var(--text-primary); margin-bottom: 15px; font-weight: 700; font-size: 2.5em;
            transition: color var(--transition-speed) ease;
        }
        h2 {
            color: var(--text-secondary); margin-bottom: 20px; font-weight: 400; font-size: 1.1em;
            transition: color var(--transition-speed) ease;
        }
        .game-options {
            margin-bottom: 25px; padding: 15px; background-color: var(--stat-item-bg);
            border-radius: 8px; box-shadow: var(--shadow-sm);
            transition: background-color var(--transition-speed) ease;
        }
        .game-options h3 {
            font-size: 1.1em; color: var(--text-primary); margin-bottom: 15px;
            text-align: left; transition: color var(--transition-speed) ease;
        }
        .mode-selection, .duration-selection {
            display: flex; align-items: center; gap: 15px; margin-bottom: 10px; flex-wrap: wrap;
        }
        .mode-selection label, .duration-selection label {
            color: var(--label-color); font-weight: 600; cursor: pointer;
            display: flex; align-items: center; gap: 5px;
            transition: color var(--transition-speed) ease;
        }
        .mode-selection input[type="radio"] { margin-right: 5px; accent-color: var(--accent-primary); }
        #countdown-duration-input {
            padding: 8px 12px; border-radius: 6px; border: 1px solid var(--input-border);
            background-color: var(--input-bg); color: var(--text-primary); width: 80px;
            font-family: 'Poppins', sans-serif; font-size: 0.9em;
            transition: border-color var(--transition-speed) ease, background-color var(--transition-speed) ease, color var(--transition-speed) ease;
        }
        #countdown-duration-input:focus {
            outline: none; border-color: var(--input-focus-border);
            box-shadow: 0 0 0 0.2rem color-mix(in srgb, var(--input-focus-border) 25%, transparent);
        }
        #countdown-settings { margin-left: 25px; display: none; }
        .difficulty-buttons { display: flex; flex-direction: column; gap: 15px; margin-bottom: 15px; }
        .difficulty-buttons button, .utility-button, #daily-challenge-btn {
            padding: 15px 25px; cursor: pointer; border-radius: 30px; border: none;
            font-weight: 600; font-size: 1.1em; color: white;
            transition: background var(--transition-speed) ease, transform var(--transition-speed) ease, box-shadow var(--transition-speed) ease;
            box-shadow: var(--shadow-md); display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .difficulty-buttons button:hover:not(:disabled),
        .utility-button:hover:not(:disabled),
        #daily-challenge-btn:hover:not(:disabled) { transform: translateY(-3px) scale(1.02); box-shadow: var(--shadow-lg); }

        .difficulty-buttons button:active:not(:disabled),
        .utility-button:active:not(:disabled),
        #daily-challenge-btn:active:not(:disabled) { transform: translateY(0) scale(1); box-shadow: var(--shadow-md); }

        #easy-btn    { background: var(--button-easy-bg); }
        #easy-btn:hover:not(:disabled) { background: var(--button-easy-hover); }
        #medium-btn  { background: var(--button-medium-bg); }
        #medium-btn:hover:not(:disabled) { background: var(--button-medium-hover); }
        #hard-btn    { background: var(--button-hard-bg); }
        #hard-btn:hover:not(:disabled) { background: var(--button-hard-hover); }
        #stats-btn { background: var(--button-stats-bg); }
        #stats-btn:hover:not(:disabled) { background: var(--button-stats-hover); }
        #daily-challenge-btn { background: var(--button-daily-bg); margin-top: 0; margin-bottom: 25px; }
        #daily-challenge-btn:hover:not(:disabled) { background: var(--button-daily-hover); }


        .difficulty-buttons button:disabled, .utility-button:disabled, #daily-challenge-btn:disabled {
            background: var(--button-disabled-bg); color: var(--button-disabled-text);
            cursor: not-allowed; box-shadow: none; transform: none;
        }
        .difficulty-buttons button i, .utility-button i, #daily-challenge-btn i { font-size: 1.2em; }

        #loading-spinner {
            display: none; margin: 20px auto; width: 40px; height: 40px;
            border: 5px solid var(--spinner-light); border-top: 5px solid var(--spinner-dark);
            border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #error-message-home {
            display: none; margin-top: 20px; padding: 10px 15px;
            background-color: var(--error-bg); color: var(--error-text);
            border: 1px solid var(--error-border); border-radius: 8px; font-weight: 600;
            transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease, border-color var(--transition-speed) ease;
        }
        .modal-overlay {
            position: fixed; inset: 0; background-color: var(--modal-overlay-bg);
            display: none; align-items: center; justify-content: center;
            z-index: 1000; opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease, visibility 0s linear 0.3s, background-color var(--transition-speed) ease;
        }
        .modal-overlay.modal-open { opacity: 1; visibility: visible; display:flex; transition: opacity 0.3s ease; }
        .modal-content {
            background: var(--container-bg); padding: 30px 40px; border-radius: 15px;
            box-shadow: var(--shadow-lg); max-width: 550px; /* Increased width for leaderboard */
            width: 90%;
            text-align: left; color: var(--text-primary); transform: scale(0.9);
            transition: transform 0.3s ease, background-color var(--transition-speed) ease, color var(--transition-speed) ease;
        }
        .modal-overlay.modal-open .modal-content { transform: scale(1); }
        .modal-title {
            font-size: 1.4em; 
            font-weight: 700; margin-bottom: 20px;
            display: flex; align-items: center; justify-content: space-between;
            color: var(--accent-primary); transition: color var(--transition-speed) ease;
        }
        .modal-title .close-modal-btn {
            background: none; border: none; font-size: 1.5em; cursor: pointer;
            color: var(--text-secondary); transition: color var(--transition-speed) ease;
        }
        .modal-title .close-modal-btn:hover { color: var(--text-primary); }
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); 
            gap: 15px; 
            margin-bottom: 20px; 
        }
        .stat-item {
            background-color: var(--stat-item-bg); padding: 12px; border-radius: 8px;
            text-align: center; box-shadow: var(--shadow-sm);
            transition: background-color var(--transition-speed) ease;
        }
        .stat-item h4 {
            margin-bottom: 6px; font-size: 0.8em; 
            color: var(--text-secondary);
            font-weight: 600; text-transform: uppercase;
            line-height: 1.2;
            transition: color var(--transition-speed) ease;
        }
        .stat-item p {
            font-size: 1.3em; 
            font-weight: 700; color: var(--accent-primary); margin:0;
            display: flex; align-items: center; justify-content: center;
            transition: color var(--transition-speed) ease;
        }
        .stat-item .stars { margin-left: 8px; color: var(--star-color); font-size: 0.75em; }
        .stat-item .stars .fa-star { margin-right: 2px; }
        .badge {
            display: inline-block; padding: 0.25em 0.6em; font-size: 0.7em; 
            font-weight: 700; line-height: 1; text-align: center;
            white-space: nowrap; vertical-align: baseline; border-radius: 0.375rem;
            margin-left: 8px;
        }
        .badge-perfect { color: #fff; background: var(--badge-perfect-bg); }

        .leaderboard-container {
            grid-column: 1 / -1; /* Span full width if stats-grid is 2 or 3 columns */
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--input-border);
            transition: border-color var(--transition-speed) ease;
        }
        .leaderboard-container h5 {
            font-size: 1.1em; /* Slightly larger than stat-item h4 */
            color: var(--text-primary);
            margin-bottom: 12px;
            text-align: center;
            transition: color var(--transition-speed) ease;
        }
        .leaderboard-filters {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .leaderboard-filters label {
            font-size: 0.9em;
            color: var(--label-color);
             transition: color var(--transition-speed) ease;
        }
        .leaderboard-filters select {
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid var(--input-border);
            background-color: var(--leaderboard-filter-bg); /* Use specific var or input-bg */
            color: var(--text-primary);
            font-family: 'Poppins', sans-serif;
            font-size: 0.9em;
            transition: border-color var(--transition-speed) ease, background-color var(--transition-speed) ease, color var(--transition-speed) ease;
        }
        #leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em; /* Slightly smaller for more data */
        }
        #leaderboard-table th, #leaderboard-table td {
            padding: 8px 5px;
            text-align: left;
            border-bottom: 1px solid var(--leaderboard-table-border);
            color: var(--text-primary);
            transition: color var(--transition-speed) ease, border-color var(--transition-speed) ease;
        }
        #leaderboard-table th {
            color: var(--text-secondary);
            font-weight: 600;
        }
        html.dark-theme #leaderboard-table th {
             color: var(--text-secondary); /* Ensure good contrast in dark mode */
        }
        #leaderboard-table td:nth-child(1) { width: 10%; text-align: right; padding-right:10px;} /* Rank */
        #leaderboard-table td:nth-child(3) { text-align: right; padding-right: 5px; } /* Score */
        #leaderboard-table td:nth-child(4) { text-align: center; font-size: 0.9em; } /* Details */

        #leaderboard-loading, #no-leaderboard-data { 
            text-align: center; 
            color: var(--text-secondary); 
            font-style: italic;
            padding: 10px;
            transition: color var(--transition-speed) ease;
        }


        @media (max-width: 480px) {
            .container { padding: 25px 15px; }
            #theme-toggle-btn { top: 10px; right: 10px; font-size: 1.2em; }
            h1 { font-size: 2em; } h2 { font-size: 1em; margin-bottom: 15px;}
            .game-options h3 { font-size: 1em; }
            .mode-selection, .duration-selection { gap: 10px; }
            .difficulty-buttons button, .utility-button, #daily-challenge-btn { font-size: 1em; padding: 12px 20px; }
            .modal-content { padding: 20px; max-width: 95%; } /* Adjust modal padding */
            .modal-title { font-size: 1.2em; }
            .stats-grid { grid-template-columns: 1fr; } 
            .difficulty-stats-container { grid-column: span 1; }
            .difficulty-stats-grid { grid-template-columns: 1fr; } 
            .stat-item p { font-size: 1.2em;} /* Adjust stat font sizes */
            .stat-item h4 { font-size: 0.75em;}
            #leaderboard-table { font-size: 0.8em; }
            #leaderboard-table td:nth-child(1) { width: 15%;}
        }
    </style>
</head>
<body>
    <div class="container">
        <button id="theme-toggle-btn" aria-label="Toggle dark mode">
            <i class="fas fa-moon"></i>
        </button>

        <h1>WordLinks</h1>
        <h2>Select a difficulty, game mode, or try the Daily Challenge!</h2>

        <div class="game-options">
            <h3>Game Mode</h3>
            <div class="mode-selection">
                <label for="mode-classic">
                    <input type="radio" id="mode-classic" name="gameMode" value="classic" checked>
                    <i class="fas fa-stopwatch"></i> Classic
                </label>
                <label for="mode-countdown">
                    <input type="radio" id="mode-countdown" name="gameMode" value="countdown">
                    <i class="fas fa-hourglass-half"></i> Countdown
                </label>
            </div>
            <div id="countdown-settings">
                <label for="countdown-duration-input">Duration (minutes): </label>
                <input type="number" id="countdown-duration-input" value="3" min="1" max="10">
            </div>
        </div>

        <div class="difficulty-buttons">
            <button id="easy-btn" data-difficulty="easy"><i class="fas fa-seedling"></i> Easy</button>
            <button id="medium-btn" data-difficulty="medium"><i class="fas fa-balance-scale"></i> Medium</button>
            <button id="hard-btn" data-difficulty="hard"><i class="fas fa-fire"></i> Hard</button>
        </div>

        <button id="daily-challenge-btn"><i class="fas fa-calendar-day"></i> Daily Challenge</button>

        <button id="stats-btn" class="utility-button" style="margin-top: 25px;"><i class="fas fa-chart-bar"></i> View Stats</button>

        <div id="loading-spinner"></div>
        <p id="error-message-home"></p>
    </div>

    <div id="stats-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-title">
                <span>Performance Dashboard & Leaderboard</span>
                <button id="close-stats-modal-btn" class="close-modal-btn" aria-label="Close statistics modal">&times;</button>
            </div>
            <div class="stats-grid">
                <div class="stat-item"><h4>Wins</h4><p id="stats-wins">0</p></div>
                <div class="stat-item"><h4>Losses</h4><p id="stats-losses">0</p></div>
                <div class="stat-item">
                    <h4>Win Rate</h4><p id="stats-win-rate">0%</p>
                </div>
                <div class="stat-item">
                    <h4>Avg. Hints / Game</h4><p><span id="stats-avg-hints">0.0</span></p>
                </div>
                <div class="stat-item">
                    <h4>Avg. Mistakes / Game</h4><p><span id="stats-avg-mistakes">0.0</span></p>
                </div>
                <div class="stat-item">
                    <h4>Perfect Wins</h4>
                    <p><span id="stats-perfect-wins">0</span><span id="perfect-wins-badge"></span></p>
                </div>
                <div class="stat-item">
                    <h4>Current Streak</h4>
                    <p><span id="stats-current-streak">0</span><span id="current-streak-stars" class="stars"></span></p>
                </div>
                <div class="stat-item">
                    <h4>Max Streak</h4>
                    <p><span id="stats-max-streak">0</span><span id="max-streak-stars" class="stars"></span></p>
                </div>
                <div class="stat-item" style="grid-column: span 2;">
                    <h4>Fastest Solve Time (Classic)</h4>
                    <p id="stats-fastest-time">N/A</p>
                </div>

                <div class="difficulty-stats-container">
                    <h5>Performance by Difficulty</h5>
                    <div class="difficulty-stats-grid">
                        <div class="difficulty-stat-item">
                            <strong>Easy</strong>
                            <span id="stats-easy-winrate">WR: N/A</span>
                            <span id="stats-easy-avghints">Hints: N/A</span>
                        </div>
                        <div class="difficulty-stat-item">
                            <strong>Medium</strong>
                            <span id="stats-medium-winrate">WR: N/A</span>
                            <span id="stats-medium-avghints">Hints: N/A</span>
                        </div>
                        <div class="difficulty-stat-item">
                            <strong>Hard</strong>
                            <span id="stats-hard-winrate">WR: N/A</span>
                            <span id="stats-hard-avghints">Hints: N/A</span>
                        </div>
                    </div>
                </div>
                
                <div class="leaderboard-container">
                    <h5>Top Scores (Classic Mode)</h5>
                    <div class="leaderboard-filters">
                        <label for="leaderboard-difficulty-filter">Difficulty:</label>
                        <select id="leaderboard-difficulty-filter">
                            <option value="">All Classic</option>
                            <option value="easy">Easy</option>
                            <option value="medium">Medium</option>
                            <option value="hard">Hard</option>
                            <option value="Daily Challenge">Daily Challenge</option> 
                        </select>
                    </div>
                    <div id="leaderboard-loading" style="display:none;">Loading leaderboard...</div>
                    <table id="leaderboard-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Name</th>
                                <th>Score</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboard-body"></tbody>
                    </table>
                    <p id="no-leaderboard-data" style="display:none;">No scores yet for this selection!</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const difficultyButtons = document.querySelectorAll('.difficulty-buttons button');
            const dailyChallengeBtn = document.getElementById('daily-challenge-btn');
            const loadingSpinner = document.getElementById('loading-spinner');
            const errorMessageHome = document.getElementById('error-message-home');
            const PUZZLE_STORAGE_KEY = 'currentPuzzle';
            const STATS_STORAGE_KEY = 'wordLinksGameStats';
            const THEME_STORAGE_KEY = 'wordLinksTheme';

            const statsBtn = document.getElementById('stats-btn');
            const statsModal = document.getElementById('stats-modal');
            const closeStatsModalBtn = document.getElementById('close-stats-modal-btn');
            const themeToggleBtn = document.getElementById('theme-toggle-btn');
            const sunIconClass = 'fa-sun';
            const moonIconClass = 'fa-moon';

            const gameModeRadios = document.querySelectorAll('input[name="gameMode"]');
            const countdownSettingsDiv = document.getElementById('countdown-settings');
            const countdownDurationInput = document.getElementById('countdown-duration-input');
            
            const leaderboardBody = document.getElementById('leaderboard-body');
            const leaderboardLoading = document.getElementById('leaderboard-loading');
            const noLeaderboardDataMsg = document.getElementById('no-leaderboard-data');
            const leaderboardDifficultyFilter = document.getElementById('leaderboard-difficulty-filter');


            function showLoading(show = true) {
                if (loadingSpinner) loadingSpinner.style.display = show ? 'block' : 'none';
                difficultyButtons.forEach(btn => btn.disabled = show);
                if (dailyChallengeBtn) dailyChallengeBtn.disabled = show;
                if (statsBtn) statsBtn.disabled = show;
                if (errorMessageHome) errorMessageHome.style.display = 'none';
            }

            function showError(message) {
                if (errorMessageHome) {
                    errorMessageHome.textContent = message;
                    errorMessageHome.style.display = 'block';
                }
                if (loadingSpinner && loadingSpinner.style.display === 'block') {
                    showLoading(false);
                }
            }

            async function startGame(difficulty, isDaily = false) {
                showLoading(true);
                let selectedGameMode = 'classic';
                let countdownDurationSeconds = 0;

                if (!isDaily) {
                    document.querySelectorAll('input[name="gameMode"]').forEach(radio => {
                        if (radio.checked) selectedGameMode = radio.value;
                    });
                    if (selectedGameMode === 'countdown') {
                        const minutes = parseInt(countdownDurationInput.value, 10);
                        if (isNaN(minutes) || minutes < 1 || minutes > 10) {
                            showError("Valid countdown: 1-10 min.");
                            showLoading(false); return;
                        }
                        countdownDurationSeconds = minutes * 60;
                    }
                }

                let performanceDataForBackend = null;
                if (!isDaily && difficulty) { 
                    const storedStats = localStorage.getItem(STATS_STORAGE_KEY);
                    if (storedStats) {
                        try {
                            const parsedStats = JSON.parse(storedStats);
                            const difficultyKey = difficulty.toLowerCase(); 
                            if (parsedStats.performance && parsedStats.performance[difficultyKey]) {
                                const perf = parsedStats.performance[difficultyKey];
                                if (perf.plays > 0) { 
                                    performanceDataForBackend = {
                                        avg_hints: perf.totalHints / perf.plays,
                                        avg_mistakes: perf.totalMistakes / perf.plays,
                                        win_rate: perf.wins / perf.plays,
                                        avg_solve_time: perf.totalTime / perf.plays, 
                                        plays: perf.plays
                                    };
                                }
                            }
                        } catch (e) { console.error("Error reading stats for backend:", e); }
                    }
                }

                try {
                    let response;
                    let endpoint = isDaily ? '/api/daily_challenge' : '/api/generate_puzzle';
                    let fetchOptions = { method: isDaily ? 'GET' : 'POST' };
                    if (!isDaily) {
                        fetchOptions.headers = { 'Content-Type': 'application/json' };
                        const payload = { difficulty: difficulty };
                        if (performanceDataForBackend) {
                            payload.user_performance_summary = performanceDataForBackend;
                        }
                        fetchOptions.body = JSON.stringify(payload);
                    }
                    response = await fetch(endpoint, fetchOptions);

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ detail: `HTTP error ${response.status}` }));
                        throw new Error(errorData.detail || `Failed to load puzzle: ${response.statusText}`);
                    }
                    const puzzleData = await response.json();
                    if (puzzleData && puzzleData.puzzle_id && puzzleData.words) {
                        sessionStorage.setItem(PUZZLE_STORAGE_KEY, JSON.stringify(puzzleData));
                        sessionStorage.setItem('gameMode', isDaily ? 'classic' : selectedGameMode);
                        if (!isDaily && selectedGameMode === 'countdown') {
                            sessionStorage.setItem('countdownDuration', countdownDurationSeconds.toString());
                        } else {
                            sessionStorage.removeItem('countdownDuration');
                        }
                        sessionStorage.setItem('isDailyChallenge', isDaily.toString());

                        document.body.classList.add('fade-out');
                        setTimeout(() => { window.location.href = '/game'; }, 300);
                    } else {
                        throw new Error("Received invalid puzzle data from server.");
                    }
                } catch (error) {
                    console.error("Failed to start game:", error);
                    showError(`Failed to start game: ${error.message}. Please try again.`);
                }
            }

            difficultyButtons.forEach(button => {
                button.addEventListener('click', () => startGame(button.dataset.difficulty, false));
            });

            if (dailyChallengeBtn) {
                dailyChallengeBtn.addEventListener('click', () => startGame(null, true));
            }

            gameModeRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.value === 'countdown' && this.checked) {
                        if(countdownSettingsDiv) countdownSettingsDiv.style.display = 'block';
                    } else {
                        if(countdownSettingsDiv) countdownSettingsDiv.style.display = 'none';
                    }
                });
            });
            const modeCountdownRadio = document.getElementById('mode-countdown');
            if (modeCountdownRadio && countdownSettingsDiv) { 
                if (modeCountdownRadio.checked) {
                     countdownSettingsDiv.style.display = 'block';
                } else {
                     countdownSettingsDiv.style.display = 'none';
                }
            }

            function displayStats() {
                const storedStats = localStorage.getItem(STATS_STORAGE_KEY);
                let defaultPerformanceSub = { plays: 0, wins: 0, totalHints: 0, totalMistakes: 0, totalTime: 0 };
                let stats = { 
                    wins: 0, losses: 0, currentStreak: 0, maxStreak: 0, fastestTime: null, perfectWins: 0,
                    performance: {
                        easy: { ...defaultPerformanceSub },
                        medium: { ...defaultPerformanceSub },
                        hard: { ...defaultPerformanceSub }
                    }
                };

                if (storedStats) {
                    try {
                        const parsed = JSON.parse(storedStats);
                        stats = { 
                            ...stats, 
                            ...parsed, 
                            performance: { 
                                easy: { ...defaultPerformanceSub, ...(parsed.performance?.easy || {}) },
                                medium: { ...defaultPerformanceSub, ...(parsed.performance?.medium || {}) },
                                hard: { ...defaultPerformanceSub, ...(parsed.performance?.hard || {}) }
                            }
                        };
                    } catch(e) { console.error("Error parsing stats, using defaults.", e); }
                }

                document.getElementById('stats-wins').textContent = stats.wins;
                document.getElementById('stats-losses').textContent = stats.losses;

                const totalPlaysOverall = stats.wins + stats.losses;
                const winRateOverall = totalPlaysOverall > 0 ? ((stats.wins / totalPlaysOverall) * 100).toFixed(0) : 0;
                document.getElementById('stats-win-rate').textContent = `${winRateOverall}%`;

                let totalHintsAll = 0;
                let totalMistakesAll = 0;
                let playsWithPerfData = 0; 
                for (const diff in stats.performance) {
                    if (stats.performance.hasOwnProperty(diff) && stats.performance[diff].plays > 0) {
                        totalHintsAll += stats.performance[diff].totalHints;
                        totalMistakesAll += stats.performance[diff].totalMistakes;
                        playsWithPerfData += stats.performance[diff].plays;
                    }
                }
                const avgHintsOverall = playsWithPerfData > 0 ? (totalHintsAll / playsWithPerfData).toFixed(1) : "0.0";
                const avgMistakesOverall = playsWithPerfData > 0 ? (totalMistakesAll / playsWithPerfData).toFixed(1) : "0.0";
                document.getElementById('stats-avg-hints').textContent = avgHintsOverall;
                document.getElementById('stats-avg-mistakes').textContent = avgMistakesOverall;

                const currentStreakEl = document.getElementById('stats-current-streak');
                const currentStreakStarsEl = document.getElementById('current-streak-stars');
                if(currentStreakEl) currentStreakEl.textContent = stats.currentStreak;
                if(currentStreakStarsEl) currentStreakStarsEl.innerHTML = getStreakStarsHTML(stats.currentStreak);

                const maxStreakEl = document.getElementById('stats-max-streak');
                const maxStreakStarsEl = document.getElementById('max-streak-stars');
                if(maxStreakEl) maxStreakEl.textContent = stats.maxStreak;
                if(maxStreakStarsEl) maxStreakStarsEl.innerHTML = getStreakStarsHTML(stats.maxStreak);

                const perfectWinsEl = document.getElementById('stats-perfect-wins');
                const perfectWinsBadgeEl = document.getElementById('perfect-wins-badge');
                if(perfectWinsEl) perfectWinsEl.textContent = stats.perfectWins || 0;
                if(perfectWinsBadgeEl) {
                    if ((stats.perfectWins || 0) > 0) {
                        perfectWinsBadgeEl.innerHTML = `<span class="badge badge-perfect">Perfect!</span>`;
                    } else {
                        perfectWinsBadgeEl.innerHTML = '';
                    }
                }

                const fastestTimeEl = document.getElementById('stats-fastest-time');
                if(fastestTimeEl) {
                    if (stats.fastestTime !== null && stats.fastestTime !== undefined) {
                        const minutes = Math.floor(stats.fastestTime / 60);
                        const seconds = stats.fastestTime % 60;
                        fastestTimeEl.textContent =
                            `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                    } else {
                        fastestTimeEl.textContent = 'N/A';
                    }
                }
                
                ['easy', 'medium', 'hard'].forEach(diff => {
                    const perf = stats.performance[diff]; 
                    const winRateDiff = perf.plays > 0 ? ((perf.wins / perf.plays) * 100).toFixed(0) + "%" : "N/A";
                    const avgHintsDiff = perf.plays > 0 ? (perf.totalHints / perf.plays).toFixed(1) : "N/A";
                    
                    const winRateEl = document.getElementById(`stats-${diff}-winrate`);
                    const avgHintsEl = document.getElementById(`stats-${diff}-avghints`);

                    if(winRateEl) winRateEl.textContent = `WR: ${winRateDiff}`;
                    if(avgHintsEl) avgHintsEl.textContent = `Hints: ${avgHintsDiff}`;
                });
            }

            function getStreakStarsHTML(streak) {
                let starsHTML = '';
                if (streak >= 10) {
                    starsHTML = '<i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i>';
                } else if (streak >= 5) {
                    starsHTML = '<i class="fas fa-star"></i><i class="fas fa-star"></i>';
                } else if (streak >= 2) {
                    starsHTML = '<i class="fas fa-star"></i>';
                }
                return starsHTML;
            }

            async function fetchAndDisplayLeaderboard() {
                if (!leaderboardBody || !leaderboardLoading || !noLeaderboardDataMsg || !leaderboardDifficultyFilter) return;

                leaderboardLoading.style.display = 'block';
                leaderboardBody.innerHTML = ''; 
                noLeaderboardDataMsg.style.display = 'none';

                const selectedDifficulty = leaderboardDifficultyFilter.value;
                let apiUrl = `/api/leaderboard?mode=classic&limit=10`; // Default to classic, can add mode filter later
                if (selectedDifficulty && selectedDifficulty !== "All Classic") { // Adjust for "All Classic"
                    apiUrl += `&difficulty=${selectedDifficulty}`;
                }
                
                try {
                    const response = await fetch(apiUrl);
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({detail: "Failed to load leaderboard."}));
                        throw new Error(errorData.detail);
                    }
                    const data = await response.json();
                    if (data.leaderboard && data.leaderboard.length > 0) {
                        data.leaderboard.forEach((entry, index) => {
                            const row = leaderboardBody.insertRow();
                            row.insertCell().textContent = index + 1;
                            row.insertCell().textContent = entry.player_name;
                            row.insertCell().textContent = entry.score;
                            let details = entry.difficulty;
                            if (entry.time_taken_seconds !== null && entry.time_taken_seconds !== undefined) {
                                 const minutes = Math.floor(entry.time_taken_seconds / 60);
                                 const seconds = entry.time_taken_seconds % 60;
                                 details += ` (${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')})`;
                            }
                            row.insertCell().textContent = details;
                        });
                    } else {
                        noLeaderboardDataMsg.style.display = 'block';
                        noLeaderboardDataMsg.textContent = 'No scores yet for this selection!';
                    }
                } catch (error) {
                    console.error("Error fetching leaderboard:", error);
                    if(noLeaderboardDataMsg) {
                        noLeaderboardDataMsg.textContent = `Error: ${error.message}`;
                        noLeaderboardDataMsg.style.display = 'block';
                    }
                } finally {
                    if(leaderboardLoading) leaderboardLoading.style.display = 'none';
                }
            }

            function openStatsModal() {
                if(!statsModal) return;
                displayStats(); 
                fetchAndDisplayLeaderboard(); 
                statsModal.style.display = 'flex';
                setTimeout(() => statsModal.classList.add('modal-open'), 10);
            }
            function closeStatsModal() {
                if(!statsModal) return;
                statsModal.classList.remove('modal-open');
                setTimeout(() => { if(!statsModal.classList.contains('modal-open')) statsModal.style.display = 'none'; }, 300);
            }

            if (statsBtn) statsBtn.addEventListener('click', openStatsModal);
            if (closeStatsModalBtn) closeStatsModalBtn.addEventListener('click', closeStatsModal);
            if (statsModal) {
                statsModal.addEventListener('click', (event) => { if (event.target === statsModal) closeStatsModal(); });
            }
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && statsModal && statsModal.classList.contains('modal-open')) {
                    closeStatsModal();
                }
            });
            if (leaderboardDifficultyFilter) {
                 leaderboardDifficultyFilter.addEventListener('change', fetchAndDisplayLeaderboard);
            }

            function applyTheme(theme) {
                if (theme === 'dark') {
                    document.documentElement.classList.add('dark-theme');
                    if (themeToggleBtn) themeToggleBtn.innerHTML = `<i class="fas ${sunIconClass}"></i>`;
                    localStorage.setItem(THEME_STORAGE_KEY, 'dark');
                } else {
                    document.documentElement.classList.remove('dark-theme');
                    if (themeToggleBtn) themeToggleBtn.innerHTML = `<i class="fas ${moonIconClass}"></i>`;
                    localStorage.setItem(THEME_STORAGE_KEY, 'light');
                }
            }
            if (themeToggleBtn) {
                themeToggleBtn.addEventListener('click', () => {
                    if (document.documentElement.classList.contains('dark-theme')) {
                        applyTheme('light');
                    } else {
                        applyTheme('dark');
                    }
                });
            }
            const savedTheme = localStorage.getItem(THEME_STORAGE_KEY);
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (savedTheme) { applyTheme(savedTheme); }
            else if (prefersDark) { applyTheme('dark'); }
            else { applyTheme('light'); }
        });
    </script>
</body>
</html>
```